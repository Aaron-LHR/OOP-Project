Index: src/main/java/src/UI/chatRoom.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package src.UI;\n\nimport com.vdurmont.emoji.Emoji;\nimport src.Client.Client;\nimport src.Client.Flag;\nimport src.Client.ReceiveThread;\n\nimport javax.swing.*;\nimport javax.swing.border.TitledBorder;\nimport javax.swing.filechooser.FileView;\nimport javax.swing.text.BadLocationException;\nimport javax.swing.text.StyledDocument;\nimport java.awt.*;\nimport java.awt.event.*;\nimport java.io.*;\nimport java.text.SimpleDateFormat;\nimport java.util.List;\nimport java.util.Date;\n\n\npublic class chatRoom extends JFrame implements ActionListener {\n    Client client = Client.getInstance();\n    Flag runFlag = Flag.getInstance();\n    String toUsername = \"\";\n\n\n    // 聊天界面\n    JPanel topBar;\n    JLabel lbPort, lbIP, lbName, fname, fsize, fstyle, fcolor, fbackcol;\n    JTextField txtPort, txtIP, txtName;\n    JButton btnExt, btnSmt, btnRmv, btnRfrsh, btnChat, btnshift, btnImg, btnDel, btnMember;\n    JTextArea txtMsg;\n    JTextPane txtRcd;\n    StyledDocument doc;\n    JScrollPane txtScroll, txtScr, listScroll;\n    JComboBox fontName, fontSize, fontStyle, fontColor, fontBackColor;\n    JList onlineList;\n    JFileChooser fileChooser;\n\n    JFrame chatRoomFrame = new JFrame(\"Java聊天室\");\n\n    // 登录界面\n    JPanel pnlLgn;\n    JLabel lbSrvIP, lbUsr, lbPwd;\n    JTextField txtSrvIP, txtUsr, txtShift;\n    JPasswordField txtPwd;\n    JButton btnLgn, btnRgst, btnExit;\n\n    JDialog diaLgnFrame = new JDialog(this, \"登录\", true);\n\n    // 搜索群聊窗口\n    groupChat diaGrpChat;\n\n    // 群聊成员显示窗口\n    groupMember grpMember;\n\n    // 表情窗口\n    // emojiImgBox imgBox;\n    // emoji emojiClass;\n\n    // 辅助参数\n    String strName, strPwd;\n    boolean flag = true;\n    String[] str_Name = { \"宋体\", \"黑体\", \"Dialog\", \"Gulim\" };\n    String[] str_Size = { \"12\", \"14\", \"18\", \"22\", \"30\", \"40\" };\n    String[] str_Style = { \"常规\", \"斜体\", \"粗体\", \"粗斜体\" };\n    String[] str_Color = { \"黑色\", \"红色\", \"蓝色\", \"黄色\", \"绿色\" };\n    String[] str_BackColor = { \"无色\", \"灰色\", \"淡红\", \"淡蓝\", \"淡黄\", \"淡绿\" };\n\n    public chatRoom() throws IOException {\n        new Thread(new ReceiveThread(this)).start();\n\n        // 登录界面\n        pnlLgn = new JPanel();\n        pnlLgn.setLayout(null);\n\n        lbSrvIP = new JLabel(\"服务器IP：\");\n        lbUsr = new JLabel(\" 用户名：\");\n        lbPwd = new JLabel(\"    密码：\");\n        txtSrvIP = new JTextField(12);\n        txtUsr = new JTextField(12);\n        txtPwd = new JPasswordField(12);\n\n        txtSrvIP.setText(\"127.0.0.1\");\n\n        btnLgn = new JButton(\"登陆\");\n        btnRgst = new JButton(\"注册\");\n        btnExit = new JButton(\"退出\");\n\n        btnLgn.addActionListener(new ActionListener() {\n            @Override\n            public void actionPerformed(ActionEvent e) {\n                UsrLogin();\n            }\n        });\n        btnRgst.addActionListener(new ActionListener() {\n            @Override\n            public void actionPerformed(ActionEvent e) {\n                UsrRgst();\n            }\n        });\n        btnExit.addActionListener(new ActionListener() {\n            @Override\n            public void actionPerformed(ActionEvent e) {\n                try {\n                    closeDiaLgnFrame();\n                } catch (IOException | InterruptedException ex) {\n                    ex.printStackTrace();\n                }\n            }\n        });\n\n        diaLgnFrame.addWindowListener(new WindowListener() {\n            @Override\n            public void windowClosing(WindowEvent e) {\n                try {\n                    closeDiaLgnFrame();\n                } catch (IOException | InterruptedException ex) {\n                    ex.printStackTrace();\n                }\n            }\n\n            @Override\n            public void windowOpened(WindowEvent e) {}\n\n            @Override\n            public void windowClosed(WindowEvent e) {}\n\n            @Override\n            public void windowIconified(WindowEvent e) {}\n\n            @Override\n            public void windowDeiconified(WindowEvent e) {}\n\n            @Override\n            public void windowActivated(WindowEvent e) {}\n\n            @Override\n            public void windowDeactivated(WindowEvent e) {}\n        });\n\n        diaLgnFrame.setResizable(false);\n\n        diaLgnFrame.getContentPane().setLayout(new FlowLayout());\n        diaLgnFrame.getContentPane().add(lbSrvIP);\n        diaLgnFrame.getContentPane().add(txtSrvIP);\n        diaLgnFrame.getContentPane().add(lbUsr);\n        diaLgnFrame.getContentPane().add(txtUsr);\n        diaLgnFrame.getContentPane().add(lbPwd);\n        diaLgnFrame.getContentPane().add(txtPwd);\n        diaLgnFrame.getContentPane().add(btnLgn);\n        diaLgnFrame.getContentPane().add(btnRgst);\n        diaLgnFrame.getContentPane().add(btnExit);\n\n        diaLgnFrame.setSize(250, 170);\n        Dimension screen = Toolkit.getDefaultToolkit().getScreenSize();\n        Dimension frame = diaLgnFrame.getSize();\n        if (frame.width > screen.width) {\n            frame.width = screen.width;\n        }\n        if (frame.height > screen.height) {\n            frame.height = screen.height;\n        }\n\n        diaLgnFrame.setLocation((screen.width - frame.width) / 2, (screen.height - frame.height) / 2);\n        diaLgnFrame.getContentPane().setBackground(Color.gray);\n        diaLgnFrame.setVisible(true);\n        diaLgnFrame.getRootPane().setDefaultButton(btnLgn); // 默认回车按钮\n\n        if (flag) {\n\n            // 聊天室界面\n            this.setSize(850, 710);\n            this.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);\n            this.setResizable(false);\n\n            // 在屏幕居中显示\n            Dimension scr = Toolkit.getDefaultToolkit().getScreenSize();\n            Dimension fra = this.getSize();\n            if (fra.width > scr.width) {\n                fra.width = scr.width;\n            }\n            if (fra.height > scr.height) {\n                fra.height = scr.height;\n            }\n            this.setLocation((scr.width - fra.width) / 2,(scr.height - fra.height) / 2);\n\n            // 上边栏\n            topBar = new JPanel();\n            topBar.setBorder(BorderFactory.createTitledBorder(null, \"连接信息\", TitledBorder.DEFAULT_JUSTIFICATION,\n                    TitledBorder.DEFAULT_POSITION, new Font(\"宋体\", 0, 12), new Color(135, 206, 250)));\n            topBar.setLayout(null);\n            topBar.setFont(new Font(\"宋体\", 0, 12));\n            topBar.setBackground(new Color(255, 255, 255)); // white\n            topBar.setBounds(5,5, 840, 70);\n\n            // 上边栏内信息:\n            // 端口\n            lbPort = new JLabel(\"端口:\");\n            lbPort.setFont(new Font(\"宋体\", 0, 14));\n            lbPort.setBounds(10, 27, 50, 20);\n\n            txtPort = new JTextField();\n            txtPort.setText(\"1111\");\n            txtPort.setBorder(BorderFactory.createEtchedBorder());\n            txtPort.setBackground(Color.WHITE);\n            txtPort.setFont(new Font(\"宋体\", 0, 12));\n            txtPort.setEditable(false);\n            txtPort.setBounds(70, 25, 80, 30);\n\n            // 服务器IP\n            lbIP = new JLabel(\"服务器IP:\");\n            lbIP.setFont(new Font(\"宋体\", 0, 14));\n            lbIP.setBounds(170, 27, 90, 20);\n\n            txtIP = new JTextField();\n            txtIP.setText(\"127.0.0.1\");\n            txtIP.setBorder(BorderFactory.createEtchedBorder());\n            txtIP.setBackground(Color.WHITE);\n            txtIP.setFont(new Font(\"宋体\", 0, 12));\n            txtIP.setEditable(false);\n            txtIP.setBounds(270, 25, 80, 30);\n\n            // 姓名\n            lbName = new JLabel(\"姓名:\");\n            lbName.setFont(new Font(\"宋体\", 0, 14));\n            lbName.setBounds(370, 27, 50, 20);\n\n            txtName = new JTextField(10);\n            txtName.setText(strName);\n            txtName.setBorder(BorderFactory.createEtchedBorder());\n            txtName.setBackground(Color.WHITE);\n            txtName.setFont(new Font(\"宋体\", 0, 12));\n            txtName.setEditable(false);\n            txtName.setBounds(430, 25, 80, 30);\n\n            // 退出按钮\n            btnExt = new JButton(\"退出\");\n            btnExt.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    btnExt.setBackground(new Color(30, 144, 255));\n                    try {\n                        closeChatFrame();\n                    } catch (IOException | InterruptedException ex) {\n                        ex.printStackTrace();\n                    }\n                }\n            });\n            btnExt.setFont(new Font(\"宋体\", 0, 12));\n            btnExt.setBounds(720, 25, 100, 30);\n\n            txtShift = new JTextField(3);\n            txtShift.setText(\"1111\");\n            txtShift.setBorder(BorderFactory.createEtchedBorder());\n            txtShift.setBackground(Color.WHITE);\n            txtShift.setFont(new Font(\"宋体\", 0, 12));\n            txtShift.setEditable(false);\n            txtShift.setBounds(70, 20, 100, 35);\n\n            btnshift = new JButton(\"切换\");\n            btnshift.setFont(new Font(\"宋体\", 0, 12));\n            btnshift.setBounds(720, 15, 100, 35);\n            btnshift.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent actionEvent) {\n                    toUsername = txtShift.getText();\n                }\n            });\n\n            // 添加至 topBar\n            topBar.add(lbPort);\n            topBar.add(txtPort);\n            topBar.add(lbIP);\n            topBar.add(txtIP);\n            topBar.add(lbName);\n            topBar.add(txtName);\n            topBar.add(btnExt);\n\n\n            // 在线用户列表\n            onlineList = new JList();\n\n            try {\n                onlineList.setListData(getOnlineList());\n            } catch (InterruptedException | IOException err) {\n                err.printStackTrace();\n            }\n\n            onlineList.setSelectionMode(ListSelectionModel.MULTIPLE_INTERVAL_SELECTION);\n            onlineList.setSelectedIndex(0);\n\n            listScroll = new JScrollPane(onlineList);\n            listScroll.setBorder(BorderFactory.createTitledBorder(null, \"在线用户\", TitledBorder.DEFAULT_JUSTIFICATION,\n                    TitledBorder.DEFAULT_POSITION, new Font(\"宋体\", 0, 12), new Color(135, 206, 250)));\n            listScroll.setFont(new Font(\"宋体\", 0, 12));\n            listScroll.setBackground(new Color(255, 255, 255)); // white\n            listScroll.setBounds(5,80, 165, 560);\n\n            btnChat = new JButton(\"发起会话\");\n            btnChat.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    List<String> cl = onlineList.getSelectedValuesList();\n                    if (cl.size() == 1 && !toUsername.equals(cl.get(0)) && cl.get(0).charAt(0) != '群') {    //私聊\n                        popWindows(cl.get(0) + \"私聊\", \"会话邀请\");\n                        btnDel.setVisible(false);\n                        btnMember.setVisible(false);\n                        toUsername = cl.get(0);\n                        synchronized (runFlag) {\n                            runFlag.setCurToUsername(toUsername);\n                        }\n                        txtRcd.setText(\"\");\n                        try {\n                            infoReminder(toUsername, false);\n                        } catch (IOException | InterruptedException ex) {\n                            ex.printStackTrace();\n                        }\n                        try {\n                            for (String loadMessage : Client.readRecord(Client.getUsername(), toUsername)) {\n                                String[] MessageSplit = loadMessage.split(\"@\");\n                                String[] fontSplit = MessageSplit[2].split(\"#\");\n                                infoTransfer(MessageSplit[1], MessageSplit[0], fontSplit[0], Integer.parseInt(fontSplit[1]), Integer.parseInt(fontSplit[2]), fontSplit[3], fontSplit[4]);\n                            }\n                        } catch (IOException ex) {\n                            ex.printStackTrace();\n                        }\n                    }\n                    else if (cl.size() > 1 && !toUsername.equals(cl.get(0))){   //创建群聊\n                        String s = strName + \"邀请\";\n                        String[] names = new String[cl.size()];\n                        for (int i = 0; i < cl.size(); i++) {\n                            String tmp = cl.get(i);\n                            if (tmp.charAt(0) == '群') {\n                                popWindows(\"多选不能选择群聊\", \"警告\");\n                                return;\n                            }\n                            if (i != cl.size() - 1) {\n                                s += (tmp + \"、\");\n                            }\n                            else {\n                                s += tmp;\n                            }\n                            if (!tmp.equals(Client.getUsername())) {\n                                names[i] = tmp;\n                            }\n                        }\n                        try {\n                            String groupName = popGrpChat();\n                            if (client.createGroup(groupName, Client.getUsername(), names)) {\n                                popWindows(s + \"参与会话\", \"会话邀请\");\n                                btnDel.setVisible(true);\n                                btnMember.setVisible(true);\n                            }\n                            else {\n                                popWindows(\"群聊已存在，进入群聊\", \"会话邀请\");\n                                btnDel.setVisible(true);\n                                btnMember.setVisible(true);\n                                toUsername = \"群：\" + groupName + \"(\" + Client.getUsername() + \")\";\n                                synchronized (runFlag) {\n                                    runFlag.setCurToUsername(toUsername);\n                                }\n                                txtRcd.setText(\"\");\n                                try {\n                                    infoReminder(toUsername, false);\n                                } catch (IOException | InterruptedException ex) {\n                                    ex.printStackTrace();\n                                }\n                                try {\n                                    client.activateGroup(toUsername);\n                                } catch (IOException | InterruptedException ex) {\n                                    ex.printStackTrace();\n                                }\n                            }\n                        } catch (IOException | InterruptedException ex) {\n                            ex.printStackTrace();\n                        }\n\n                    }\n                    else if (cl.size() == 1 && !toUsername.equals(cl.get(0)) && cl.get(0).charAt(0) == '群') {   //进入群聊\n                        toUsername = cl.get(0);\n                        btnDel.setVisible(true);\n                        btnMember.setVisible(true);\n                        synchronized (runFlag) {\n                            runFlag.setCurToUsername(toUsername);\n                        }\n                        txtRcd.setText(\"\");\n                        try {\n                            infoReminder(toUsername, false);\n                        } catch (IOException | InterruptedException ex) {\n                            ex.printStackTrace();\n                        }\n                        try {\n                            client.activateGroup(toUsername);\n                        } catch (IOException | InterruptedException ex) {\n                            ex.printStackTrace();\n                        }\n                    }\n                    // 发起群聊或私聊\n                }\n            });\n            btnChat.setFont(new Font(\"宋体\", 0, 12));\n            btnChat.setBounds(5, 640, 80, 30);\n\n            btnRfrsh = new JButton(\"刷新\");\n            btnRfrsh.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    refresh();\n                }\n            });\n            btnRfrsh.setFont(new Font(\"宋体\", 0, 12));\n            btnRfrsh.setBounds(90, 640, 80, 30);\n\n            // 对话框\n            txtRcd = new JTextPane();\n            txtRcd.setEditable(false);\n            doc = txtRcd.getStyledDocument();\n\n            txtScr = new JScrollPane(txtRcd);\n            txtScr.setBorder(BorderFactory.createTitledBorder(null, \"聊天信息\", TitledBorder.DEFAULT_JUSTIFICATION,\n                    TitledBorder.DEFAULT_POSITION, new Font(\"宋体\", 0, 12), new Color(135, 206, 250)));\n            txtScr.setBounds(175,80, 670, 415);\n            txtScr.setBackground(new Color(255, 255, 255));\n            txtScr.setFont(new Font(\"宋体\", 0, 12));\n\n            // 字体设置\n            fname = new JLabel(\"字体\");\n            fname.setFont(new Font(\"宋体\", 0, 14));\n            fname.setBounds(175, 500, 35, 30);\n\n            fontName = new JComboBox(str_Name); // 字体名称\n            fontName.setFont(new Font(\"宋体\", 0, 12));\n            fontName.setBounds(215, 500, 90, 30);\n\n            fsize = new JLabel(\"大小\");\n            fsize.setFont(new Font(\"宋体\", 0, 14));\n            fsize.setBounds(310, 500, 35, 30);\n\n            fontSize = new JComboBox(str_Size); // 字号\n            fontSize.setFont(new Font(\"宋体\", 0, 12));\n            fontSize.setBounds(350, 500, 90, 30);\n\n            fstyle = new JLabel(\"样式\");\n            fstyle.setFont(new Font(\"宋体\", 0, 14));\n            fstyle.setBounds(445, 500, 35, 30);\n\n            fontStyle = new JComboBox(str_Style); // 样式\n            fontStyle.setFont(new Font(\"宋体\", 0, 12));\n            fontStyle.setBounds(485, 500, 90, 30);\n\n            fcolor = new JLabel(\"颜色\");\n            fcolor.setFont(new Font(\"宋体\", 0, 14));\n            fcolor.setBounds(580, 500, 35, 30);\n\n            fontColor = new JComboBox(str_Color); // 颜色\n            fontColor.setFont(new Font(\"宋体\", 0, 12));\n            fontColor.setBounds(620, 500, 90, 30);\n\n            fbackcol = new JLabel(\"背景色\");\n            fbackcol.setFont(new Font(\"宋体\", 0, 14));\n            fbackcol.setBounds(175, 535, 50, 30);\n\n            fontBackColor = new JComboBox(str_BackColor); // 背景颜色\n            fontBackColor.setFont(new Font(\"宋体\", 0, 12));\n            fontBackColor.setBounds(230, 535, 75, 30);\n\n            // 发送按钮\n            btnSmt = new JButton(\"发送\");\n            btnSmt.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    try {\n                        String s = txtMsg.getText();\n                        FontAttrib font = getFontAttrib();\n                        String color = \"黑色\";\n                        String backColor = \"无色\";\n                        if (Color.BLACK.equals(font.color)) {\n                            color = \"黑色\";\n                        } else if (Color.red.equals(font.color)) {\n                            color = \"红色\";\n                        } else if (Color.BLUE.equals(font.color)) {\n                            color = \"蓝色\";\n                        } else if (Color.YELLOW.equals(font.color)) {\n                            color = \"黄色\";\n                        } else if (Color.GREEN.equals(font.color)) {\n                            color = \"绿色\";\n                        }\n                        if (font.backColor != null) {\n                            if (font.backColor.equals(new Color(200, 200, 200))) {\n                                backColor = \"灰色\";\n                            }\n                            else if (font.backColor.equals(new Color(255, 200, 200))) {\n                                backColor = \"淡红\";\n                            }\n                            else if (font.backColor.equals(new Color(200, 200, 255))) {\n                                backColor = \"淡蓝\";\n                            }\n                            else if (font.backColor.equals(new Color(255, 255, 200))) {\n                                backColor = \"淡黄\";\n                            }\n                            else if (font.backColor.equals(new Color(200, 255, 200))) {\n                                backColor = \"淡绿\";\n                            }\n                        }\n                        String Font = font.name + \"#\" + font.style + \"#\" + font.size + \"#\" + color + \"#\" + backColor;\n                        if (toUsername.charAt(0) != '群') {  //给私聊用户发消息\n                            if (!client.sendPrivateMessage(toUsername, s, Font)) {\n                                popWindows(\"对方不在线\", \"提示\");\n                            }\n                            else {\n                                submitText(getFontAttrib(), strName);\n                                txtMsg.setText(\"\");\n                            }\n                        }\n                        else {  //给群聊发消息\n                            if (!client.sendGroupMessage(toUsername, s, Font)) {\n                                popWindows(\"群消息发送失败\", \"提示\");\n                            }\n                            else {\n//                                submitText(getFontAttrib(), strName);\n                                txtMsg.setText(\"\");\n                            }\n                        }\n                    } catch (IOException | InterruptedException ex) {\n                        ex.printStackTrace();\n                    }\n                }\n            });\n            btnSmt.setFont(new Font(\"宋体\", 0, 12));\n            btnSmt.setBounds(765, 535, 80, 30);\n\n            // 清除已编辑信息\n            btnRmv = new JButton(\"清空\");\n            btnRmv.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    txtMsg.setText(\"\");\n                }\n            });\n            btnRmv.setFont(new Font(\"宋体\", 0, 12));\n            btnRmv.setBounds(680, 535, 80, 30);\n\n            // 表情选择\n            btnImg = new JButton(\"表情\");\n\n            btnImg.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    fileChooser = new JFileChooser();\n                    File f = new File(\"./src\");\n                    String s = f.getPath() + \"/main/java/src/Icon\";\n\n                    // fileChooser.setAccessory(new ImagePreviewer(fileChooser));\n                    fileChooser.setFileView(new FileView() {\n                        @Override\n                        public ImageIcon getIcon(File f) {\n                            ImageIcon icon = new ImageIcon(f.getPath());\n                            return icon;\n                        }\n\n                        /*\n                        @Override\n                        public String getName(File f) {\n                            String s = f.getName();\n                            if (s.endsWith(\".gif\")) {\n                                return s.substring(0, s.indexOf(\".gif\")) + \".png\";\n                            }\n                            else return s;\n                        }\n\n                         */\n                    });\n\n                    fileChooser.setCurrentDirectory(new File(s));\n                    fileChooser.showOpenDialog(null);\n                    try {\n                        insertIcon(fileChooser.getSelectedFile());\n                    } catch (BadLocationException badLocationException) {\n                        badLocationException.printStackTrace();\n                    }\n                }\n            });\n\n            /*\n            btnImg.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    popImgBox();\n                }\n            });\n\n             */\n            btnImg.setFont(new Font(\"宋体\", 0, 12));\n            btnImg.setBounds(595, 535, 80, 30);\n\n            // 删除\n            btnDel = new JButton(\"退出群聊\");\n            btnDel.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    try {\n                        if (client.exitGroup(toUsername)) {\n                            popWindows(\"退出群聊成功\", \"退出群聊\");\n                            toUsername = \"\";\n                            synchronized (runFlag) {\n                                runFlag.setCurToUsername(\"\");\n                            }\n                            txtRcd.setText(\"\");\n                            refresh();\n                        }\n                        else {\n                            popWindows(\"退出群聊失败，请重试\", \"退出群聊\");\n                        }\n                    } catch (IOException | InterruptedException ex) {\n                        ex.printStackTrace();\n                    }\n                }\n            });\n            btnDel.setFont(new Font(\"宋体\", 0, 12));\n            btnDel.setBounds(510, 535, 80, 30);\n\n            // 成员列表\n            btnMember = new JButton(\"成员\");\n            btnMember.addActionListener(new ActionListener() {\n                @Override\n                public void actionPerformed(ActionEvent e) {\n                    try {\n                        popGrpMember();\n                    } catch (IOException | InterruptedException ex) {\n                        ex.printStackTrace();\n                    }\n                }\n            });\n            btnMember.setFont(new Font(\"宋体\", 0, 12));\n            btnMember.setBounds(425, 535, 80, 30);\n\n            // 编辑信息区\n            txtMsg = new JTextArea();\n            txtMsg.setLineWrap(true); // 激活自动换行功能\n            txtMsg.setWrapStyleWord(true); // 换行不换字\n\n            txtScroll = new JScrollPane(txtMsg);\n            txtScroll.setBorder(BorderFactory.createTitledBorder(null, \"发送\", TitledBorder.DEFAULT_JUSTIFICATION,\n                    TitledBorder.DEFAULT_POSITION, new Font(\"宋体\", 0, 12), new Color(135, 206, 250)));\n            txtScroll.setBounds(175, 560, 670, 113);\n            txtScroll.setBackground(new Color(250, 250, 250));\n            txtScroll.setFont(new Font(\"宋体\", 0, 12));\n\n            // 最终添加\n            setLayout(null);\n\n            add(topBar);\n\n            add(listScroll);\n            add(btnChat);\n            add(btnRfrsh);\n\n            add(txtScr);\n\n            add(fname);\n            add(fontName);\n            add(fsize);\n            add(fontSize);\n            add(fstyle);\n            add(fontStyle);\n            add(fcolor);\n            add(fontColor);\n            add(fbackcol);\n            add(fontBackColor);\n            add(txtShift);\n            add(btnshift);\n\n            add(txtScroll);\n\n            add(btnRmv);\n            add(btnSmt);\n            add(btnImg);\n            add(btnDel);\n            add(btnMember);\n            btnDel.setVisible(false);\n            btnMember.setVisible(false);\n\n            // 设置界面可见\n            setVisible(true);\n            // receive();\n\n        }\n\n    }\n\n    public void closeChatFrame() throws IOException, InterruptedException {\n        client.exit();\n        this.dispose();\n    }\n\n    public void closeDiaLgnFrame() throws IOException, InterruptedException {\n        diaLgnFrame.dispose();\n        flag = false;\n        closeChatFrame();\n    }\n\n    public void UsrRgst() {\n        try {\n            String username = txtUsr.getText().trim();\n            String password = new String(txtPwd.getPassword()).trim();\n            if (client.register(username, password)) {\n                popWindows(\"注册成功\", \"注册\");\n                diaLgnFrame.dispose(); // 登录完成后关闭登录页以启动聊天室界面\n            }\n            else {\n                popWindows(\"用户名已被占用\", \"注册\");\n            }\n        } catch (IOException | InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n\n    public void UsrLogin() {\n        try {\n            String username = txtUsr.getText().trim();\n            String password = new String(txtPwd.getPassword()).trim();\n            switch (client.Login(username, password)) {\n                case 0:\n                    popWindows(\"登录成功\", \"登录\");\n                    strName = username;\n                    strPwd = password;\n                    diaLgnFrame.dispose(); // 登录完成后关闭登录页以启动聊天室界面\n                    break;\n                case 1:\n                    popWindows(\"用户名或密码错误\", \"登录\");\n                    break;\n                case 2:\n                    popWindows(\"该用户已登录\", \"登录\");\n            }\n        } catch (IOException | InterruptedException e) {\n            e.printStackTrace();\n        }\n    }\n\n    public void submitText(FontAttrib attrib, String name) {\n        synchronized (txtRcd) {\n            try { // 插入文本\n                SimpleDateFormat df = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\"); // 设置日期格式\n\n                String s1 = df.format(new Date()) + \"  \" + name + \"\\n\";\n                String s2 = attrib.getText() + \"\\n\\n\";\n\n                FontAttrib attrib1 = new FontAttrib(s1, \"宋体\", 0, 12, Color.BLACK, Color.WHITE);\n\n                doc.insertString(doc.getLength(), s1, attrib1.getAttrSet());\n                doc.insertString(doc.getLength(), s2, attrib.getAttrSet());\n\n            } catch (BadLocationException e) {\n                e.printStackTrace();\n            }\n\n        }\n    }\n\n    public void infoTransfer(String msg, String name, String font_Name, int style, int size, String color, String backCol) {\n        Color c1 = null, c2 = null;\n\n        if (color.equals(\"黑色\")) c1 = Color.BLACK;\n        else if (color.equals(\"红色\")) c1 = Color.RED;\n        else if (color.equals(\"蓝色\")) c1 = Color.BLUE;\n        else if (color.equals(\"黄色\")) c1 = Color.YELLOW;\n        else if (color.equals(\"绿色\")) c1 = Color.GREEN;\n\n        if (backCol.equals(\"无色\")) c2 = Color.WHITE;\n        else if (backCol.equals(\"灰色\")) c2 = new Color(200, 200, 200);\n        else if (backCol.equals(\"淡红\")) c2 = new Color(255, 200, 200);\n        else if (backCol.equals(\"淡蓝\")) c2 = new Color(200, 200, 255);\n        else if (backCol.equals(\"淡黄\")) c2 = new Color(255, 255, 200);\n        else if (backCol.equals(\"淡绿\")) c2 = new Color(200, 255, 200);\n\n        FontAttrib att = new FontAttrib(msg, font_Name, style, size, c1, c2);\n\n        submitText(att, name);\n    }\n\n    /*\n    public void imgTransfer(String name, String emoji) {\n\n    }\n\n     */\n\n    public FontAttrib getFontAttrib() {\n        FontAttrib att = new FontAttrib();\n\n        att.setText(txtMsg.getText());\n        att.setName((String) fontName.getSelectedItem());\n        att.setSize(Integer.parseInt((String) fontSize.getSelectedItem()));\n\n        String temp_style = (String) fontStyle.getSelectedItem();\n        if (temp_style.equals(\"常规\")) {\n            att.setStyle(FontAttrib.GENERAL);\n        }\n        else if (temp_style.equals(\"粗体\")) {\n            att.setStyle(FontAttrib.BOLD);\n        }\n        else if (temp_style.equals(\"斜体\")) {\n            att.setStyle(FontAttrib.ITALIC);\n        }\n        else if (temp_style.equals(\"粗斜体\")) {\n            att.setStyle(FontAttrib.BOLD_ITALIC);\n        }\n\n        String temp_color = (String) fontColor.getSelectedItem();\n        if (temp_color.equals(\"黑色\")) {\n            att.setColor(new Color(0, 0, 0));\n        }\n        else if (temp_color.equals(\"红色\")) {\n            att.setColor(new Color(255, 0, 0));\n        }\n        else if (temp_color.equals(\"蓝色\")) {\n            att.setColor(new Color(0, 0, 255));\n        }\n        else if (temp_color.equals(\"黄色\")) {\n            att.setColor(new Color(255, 255, 0));\n        }\n        else if (temp_color.equals(\"绿色\")) {\n            att.setColor(new Color(0, 255, 0));\n        }\n\n        String temp_backColor = (String) fontBackColor.getSelectedItem();\n        if (!temp_backColor.equals(\"无色\")) {\n            if (temp_backColor.equals(\"灰色\")) {\n                att.setBackColor(new Color(200, 200, 200));\n            }\n            else if (temp_backColor.equals(\"淡红\")) {\n                att.setBackColor(new Color(255, 200, 200));\n            }\n            else if (temp_backColor.equals(\"淡蓝\")) {\n                att.setBackColor(new Color(200, 200, 255));\n            }\n            else if (temp_backColor.equals(\"淡黄\")) {\n                att.setBackColor(new Color(255, 255, 200));\n            }\n            else if (temp_backColor.equals(\"淡绿\")) {\n                att.setBackColor(new Color(200, 255, 200));\n            }\n        }\n\n        return att;\n    }\n\n    // 弹出提示信息\n    public void popWindows(String strWarning, String strTitle) {\n        JOptionPane.showMessageDialog(this, strWarning, strTitle, JOptionPane.INFORMATION_MESSAGE);\n    }\n\n    /* 弹出表情包\n    public void popImgBox() {\n        imgBox = new emojiImgBox(chatRoomFrame, txtMsg, emoji.getEmojiUnicode());\n    }\n\n     */\n\n    // 弹出成员列表\n    public void popGrpMember() throws IOException, InterruptedException {\n        grpMember = new groupMember(chatRoomFrame, getMemList());\n    }\n\n    public String[] getMemList() throws IOException, InterruptedException {\n        return client.getGroupMembers(toUsername);\n    }\n\n    public String[] getOnlineList() throws IOException, InterruptedException {\n        return client.getOnlineList();\n    }\n\n    public void infoReminder(String name, boolean flag) throws IOException, InterruptedException {\n//        onlineList.setListData(getOnlineList());\n        onlineList.setCellRenderer(new DefaultListCellRenderer(){\n            @Override\n            public Component getListCellRendererComponent(JList<?> list, Object value, int index, boolean isSelected, boolean cellHasFocus) {\n                super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);\n                String s = (String)value;\n                if (s.equals(name)) {\n                    if (flag) {\n                        setBackground(Color.GREEN);\n                    }\n                    else {\n                        setBackground(Color.WHITE);\n                    }\n                }\n\n\n                return this;\n            }\n        });\n\n//        popWindows(name + \"向你发送信息\", \"消息提示\");\n//\n//        onlineList.setCellRenderer(new DefaultListCellRenderer(){\n//            @Override\n//            public Component getListCellRendererComponent(JList<?> list, Object value, int index, boolean isSelected, boolean cellHasFocus) {\n//                super.getListCellRendererComponent(list, value, index, isSelected, cellHasFocus);\n//                String s = (String)value;\n//                if (s.equals(name))  setBackground(Color.WHITE);\n//                return this;\n//            }\n//        });\n    }\n\n    public void clearBox() throws BadLocationException {\n        remove(txtScr);\n        remove(txtRcd);\n        txtRcd = new JTextPane();\n        txtRcd.setEditable(false);\n        doc = txtRcd.getStyledDocument();\n\n        txtScr = new JScrollPane(txtRcd);\n        txtScr.setBorder(BorderFactory.createTitledBorder(null, \"聊天信息\", TitledBorder.DEFAULT_JUSTIFICATION,\n                TitledBorder.DEFAULT_POSITION, new Font(\"宋体\", 0, 12), new Color(135, 206, 250)));\n        txtScr.setBounds(175,80, 670, 415);\n        txtScr.setBackground(new Color(255, 255, 255));\n        txtScr.setFont(new Font(\"宋体\", 0, 12));\n\n        add(txtScr);\n        setVisible(true);\n        repaint();\n        validate();\n    }\n\n    public void refresh() {\n        try {\n            onlineList.setListData(getOnlineList());\n        } catch (InterruptedException | IOException err) {\n            err.printStackTrace();\n        }\n    }\n\n    public String popGrpChat() {\n        diaGrpChat = new groupChat(chatRoomFrame);\n        return diaGrpChat.GroupName;\n    }\n\n\n    public void insertIcon(File file) throws BadLocationException {\n        if (file != null) {\n            SimpleDateFormat df = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\"); // 设置日期格式\n            String s1 = df.format(new Date()) + \"  \" + strName + \"\\n\";\n            FontAttrib attrib1 = new FontAttrib(s1, \"宋体\", 0, 12, Color.BLACK, Color.WHITE);\n            doc.insertString(doc.getLength(), s1, attrib1.getAttrSet());\n        }\n\n        txtRcd.setCaretPosition(doc.getLength());\n        txtRcd.insertIcon(new ImageIcon(file.getPath()));\n        FontAttrib attrib = new FontAttrib();\n        doc.insertString(doc.getLength(), attrib.getText() + \"\\n\\n\", attrib.getAttrSet());\n    }\n\n    @Override\n    public void actionPerformed(ActionEvent e) {}\n\n    public static void main(String[] args) throws IOException {\n        try {//修改风格\n            for (UIManager.LookAndFeelInfo info : UIManager.getInstalledLookAndFeels()) {\n                System.out.println(info.getName());\n                if (\"Nimbus\".equals(info.getName())) {\n                    UIManager.setLookAndFeel(info.getClassName());\n                    break;\n                }\n            }\n        }catch(Exception e) {\n            System.out.println(e);\n        }\n        new chatRoom();\n    }\n\n}\n\n/*\nclass ImagePreviewer extends JLabel {\n    public ImagePreviewer(JFileChooser chooser) {\n        ImageIcon icon =\n    }\n}\n\n */
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/main/java/src/UI/chatRoom.java	(revision 80119b09ea1f4db7f41dde88d250e657e4837b06)
+++ src/main/java/src/UI/chatRoom.java	(date 1591935246899)
@@ -7,6 +7,8 @@
 
 import javax.swing.*;
 import javax.swing.border.TitledBorder;
+import javax.swing.filechooser.FileFilter;
+import javax.swing.filechooser.FileSystemView;
 import javax.swing.filechooser.FileView;
 import javax.swing.text.BadLocationException;
 import javax.swing.text.StyledDocument;
@@ -28,7 +30,7 @@
     JPanel topBar;
     JLabel lbPort, lbIP, lbName, fname, fsize, fstyle, fcolor, fbackcol;
     JTextField txtPort, txtIP, txtName;
-    JButton btnExt, btnSmt, btnRmv, btnRfrsh, btnChat, btnshift, btnImg, btnDel, btnMember;
+    JButton btnExt, btnSmt, btnRmv, btnRfrsh, btnChat, btnshift, btnImg, btnFile, btnDel, btnMember;
     JTextArea txtMsg;
     JTextPane txtRcd;
     StyledDocument doc;
@@ -551,31 +553,35 @@
                     File f = new File("./src");
                     String s = f.getPath() + "/main/java/src/Icon";
 
-                    // fileChooser.setAccessory(new ImagePreviewer(fileChooser));
                     fileChooser.setFileView(new FileView() {
                         @Override
                         public ImageIcon getIcon(File f) {
                             ImageIcon icon = new ImageIcon(f.getPath());
                             return icon;
                         }
+                    });
 
-                        /*
+                    /*
+                    fileChooser.addChoosableFileFilter(new FileFilter() {
+                        @Override
+                        public boolean accept(File f) {
+                            String path = "./" + f.getPath().substring(f.getPath().indexOf("src"), f.getPath().lastIndexOf("/"));
+                            if (!path.equals(s)) return false;
+                            return true;
+                        }
+
                         @Override
-                        public String getName(File f) {
-                            String s = f.getName();
-                            if (s.endsWith(".gif")) {
-                                return s.substring(0, s.indexOf(".gif")) + ".png";
-                            }
-                            else return s;
+                        public String getDescription() {
+                            return null;
                         }
+                    });
 
-                         */
-                    });
+                     */
 
                     fileChooser.setCurrentDirectory(new File(s));
-                    fileChooser.showOpenDialog(null);
+                    int val = fileChooser.showOpenDialog(null);
                     try {
-                        insertIcon(fileChooser.getSelectedFile());
+                        if (val == JFileChooser.APPROVE_OPTION) insertIcon(fileChooser.getSelectedFile());
                     } catch (BadLocationException badLocationException) {
                         badLocationException.printStackTrace();
                     }
@@ -594,7 +600,23 @@
             btnImg.setFont(new Font("宋体", 0, 12));
             btnImg.setBounds(595, 535, 80, 30);
 
-            // 删除
+            // 选择文件上传
+            btnFile = new JButton("文件");
+            btnFile.addActionListener(new ActionListener() {
+                @Override
+                public void actionPerformed(ActionEvent e) {
+                    fileChooser = new JFileChooser();
+                    File f = FileSystemView.getFileSystemView() .getHomeDirectory();
+
+                    fileChooser.setCurrentDirectory(new File(f.getPath()));
+                    int val = fileChooser.showOpenDialog(null);
+                    if (val == JFileChooser.APPROVE_OPTION) fileTransfer(fileChooser.getSelectedFile());
+                }
+            });
+            btnFile.setFont(new Font("宋体", 0, 12));
+            btnFile.setBounds(510, 535, 80, 30);
+
+            // 退出群聊
             btnDel = new JButton("退出群聊");
             btnDel.addActionListener(new ActionListener() {
                 @Override
@@ -618,7 +640,7 @@
                 }
             });
             btnDel.setFont(new Font("宋体", 0, 12));
-            btnDel.setBounds(510, 535, 80, 30);
+            btnDel.setBounds(425, 535, 80, 30);
 
             // 成员列表
             btnMember = new JButton("成员");
@@ -633,7 +655,7 @@
                 }
             });
             btnMember.setFont(new Font("宋体", 0, 12));
-            btnMember.setBounds(425, 535, 80, 30);
+            btnMember.setBounds(340, 535, 80, 30);
 
             // 编辑信息区
             txtMsg = new JTextArea();
@@ -676,6 +698,7 @@
             add(btnRmv);
             add(btnSmt);
             add(btnImg);
+            add(btnFile);
             add(btnDel);
             add(btnMember);
             btnDel.setVisible(false);
@@ -779,12 +802,10 @@
         submitText(att, name);
     }
 
-    /*
-    public void imgTransfer(String name, String emoji) {
+    public void imgTransfer() {
 
     }
 
-     */
 
     public FontAttrib getFontAttrib() {
         FontAttrib att = new FontAttrib();
@@ -940,6 +961,12 @@
 
 
     public void insertIcon(File file) throws BadLocationException {
+        File f = new File("./src");
+        String s = f.getPath() + "/main/java/src/Icon";
+        String path = "./" + file.getPath().substring(file.getPath().indexOf("src"), file.getPath().lastIndexOf("/"));
+
+        if (!path.equals(s)) return;
+
         if (file != null) {
             SimpleDateFormat df = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"); // 设置日期格式
             String s1 = df.format(new Date()) + "  " + strName + "\n";
@@ -953,6 +980,10 @@
         doc.insertString(doc.getLength(), attrib.getText() + "\n\n", attrib.getAttrSet());
     }
 
+    public void fileTransfer(File selectedFile) {
+
+    }
+
     @Override
     public void actionPerformed(ActionEvent e) {}
 
